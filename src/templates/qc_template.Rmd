
```{r, echo = FALSE}

# Input variables from parent Rmd
desc      <- {{desc}}
qc_meta   <- {{qc_meta}}
filt_meta <- {{filt_meta}}

if (!"qc_class" %in% colnames(qc_meta)) {
  stop("The column 'qc_class' must be present in the qc_meta data.frame")
}

```

```{r "qc_sobj", echo = FALSE}

# Format data for qc plots
log_vars <- "nCount_RNA"

qc_meta <- qc_meta %>%
  mutate(
    across(
      all_of(log_vars),
      ~ log10(.x + 1),
      .names = "{.col}_log10"
    ),
    sample = fct_relevel(sample, sam_lvls)
  )

n_tot_cells <- nrow(qc_meta)

# Format filtered data
filt_meta <- filt_meta %>%
  mutate(
    across(
      all_of(log_vars),
      ~ log10(.x + 1),
      .names = "{.col}_log10"
    ),
    sample = fct_relevel(sample, sam_lvls)
  )

n_filt_cells <- nrow(filt_meta)
  
```

## Quality control {.tabset .tabset-pills}

Cell Ranger identified `r format(n_tot_cells, big.mark = ",", scientific = FALSE)` cells.

`r desc`

Cells were filtered to only include those with >`r format(params$gene_min, big.mark = ",", scientific = FALSE)` and <`r format(params$gene_max, big.mark = ",", scientific = FALSE)` detected genes and <`r params$mito_max`% mitochondrial counts. `r format(n_filt_cells, big.mark = ",", scientific = FALSE)` cells remained for downstream analysis after filtering.

### Summary

```{r "qc_vlns", fig.width = 12, fig.height = 3.5}

# Create violin plots
qc_mets <- c("nCount_RNA_log10", "nFeature_RNA", "pct_mito")

qc_meta %>%
  pivot_longer(cols = all_of(qc_mets)) %>%
  
  ggplot(aes(sample, value, color = sample, fill = sample)) +
  
  geom_violin(
    draw_quantiles = c(0.25, 0.75),
    alpha          = al,
    color          = "black",
    size           = 0.4,
    scale          = "width"
  ) +
  
  stat_summary(geom = "point", fun = median, color = "black") +
  
  facet_wrap(~ name, scales = "free", nrow = 1) +
  scale_fill_manual(values = sam_cols) +
  scale_color_manual(values = sam_cols) +
  base_theme +
  theme(
    legend.position = "none",
    axis.title      = element_blank(),
    axis.text.x     = element_text(angle = 45, hjust = 1),
    axis.line       = element_blank(),
    panel.border    = element_rect(fill = NA, color = "grey85")
  )

```

<br>

The number of cells filtered from each sample is shown below.

```{r "qc_bars", fig.width = 12, fig.height = 3}

# Create bar graphs
bar_labs <- get_nlab_fun(qc_meta, "qc_class")
bar_cols <- ito_cols[c(1:3, 5, 4)]

qc_meta %>%
  ggplot(aes(sample, fill = qc_class, color = qc_class)) +
  geom_bar(key_glyph = draw_key_point, color = "black", size = 0.2, alpha = 0.8) +
  
  coord_flip() +
  scale_color_manual(values = bar_cols) +
  scale_fill_manual(values = bar_cols, labels = bar_labs) +
  
  guides(
    fill  = guide_legend(override.aes = list(size = 4, shape = 22)),
    color = "none"
  ) +
  
  labs(y = "cell count") +
  base_theme +
  theme(
    plot.margin       = unit(c(0.2, 9, 0.2, 0.2, 0.2), "cm"),
    legend.title      = element_blank(),
    legend.key.height = unit(30, "pt"),
    axis.title.y      = element_blank()
  )

```

<br>

### Cell Ranger

Cell Ranger metrics are shown for each sample.

```{r "cellranger", fig.width = 10, fig.height = 11}

cr_mets <- read_csv(metrics)

cr_mets <- cr_mets %>%
  mutate(
    across(everything(), as.character),
    sample = unname(sam_lvls[sample])
  ) %>%
  pivot_longer(-sample, names_to = "key", values_to = "value") %>%
  mutate(
    key    = str_remove(key, "\\(.+\\)"),
    key    = str_trim(key),
    key    = ifelse(grepl("%", value), str_c(key, " (%)"), key),
    key    = str_wrap(key, width = 35),
    value  = str_remove(value, "%"),
    value  = as.double(value),
    sample = fct_relevel(sample, sam_lvls)
  )

cr_mets %>%
  ggplot(aes(sample, value, fill = sample)) +
  geom_col(color = "black", size = 0.2, alpha = al) +
  facet_wrap(~ key, scales = "free_y", ncol = 4) +
  scale_fill_manual(values = sam_cols) +
  guides(fill = guide_legend(nrow = 1)) +
  base_theme +
  theme(
    legend.position = "top",
    legend.title    = element_blank(),
    strip.text      = element_text(size = 8),
    axis.title      = element_blank(),
    axis.text       = element_text(size = 6),
    axis.text.x     = element_blank(),
    axis.ticks.x    = element_blank()
  )

```

<br>

### Scatter plots

Cell quality metrics are compared below, low quality cells are shown in gray.

```{r "qc_scatter", fig.width = 3 * n_rep, fig.height = 11.5}

# Create scatter plots
scat_mets <- list(
  c("nCount_RNA",   "nFeature_RNA"),
  c("nFeature_RNA", "pct_mito")
)

sam_labs <- get_nlab_fun(qc_meta, "sample", nm = FALSE)

scat_mets %>%
  map(~ {
    qc_meta %>%
      mutate(n = sam_labs(sample)) %>%
      ggplot(aes(!!sym(.x[1]), !!sym(.x[2]), fill = sample)) +
      geom_point_trace(
        trace_position    = qc_class == "pass",
        background_params = list(fill = "grey75"),
        color             = NA,
        size              = 0.01,
        alpha             = al
      ) +
      
      geom_text(
        aes(Inf, Inf, label = n),
        check_overlap = TRUE,
        color         = "black",
        hjust         = 1.1,
        vjust         = 1.5,
        size          = txt_pt1 * 0.9 / .pt
      ) +
      
      scale_fill_manual(values = sam_cols) +
      facet_wrap(~ sample, nrow = 2, scales = "free") +
      guides(color = guide_legend(override.aes = list(size = 3), nrow = 1)) +
      base_theme +
      theme(
        legend.title    = element_blank(),
        legend.position = "none",
        axis.text       = element_text(size = txt_pt1 * 0.9),
        axis.title      = element_text(size = txt_pt1),
        axis.line       = element_blank(),
        panel.border    = element_rect(fill = NA, color = "grey85")
      )
  }) %>%
  plot_grid(
    plotlist = .,
    ncol     = 1,
    align    = "h",
    axis     = "tb"
  )

```

<br>

### UMAPs

UMAP projections are shown for each replicate after filtering.

```{r "QC_UMAPs", fig.width = 3.33 * n_rep, fig.height = 10}

# UMAP colors
umap_cols <- get_cols()[seq_along(qc_mets)]

umap_cols <- qc_mets %>%
  set_names(umap_cols, .)

rep_labs <- get_nlab_fun(filt_meta, "rep", nm = FALSE)

# Create UMAPs
umap_cols %>%
  imap(~ {
    filt_meta %>%
      mutate(n = rep_labs(rep)) %>%
      pivot_longer(cols = all_of(qc_mets)) %>%
      filter(name == .y) %>%
      
      ggplot(aes(UMAP_1, UMAP_2, color = value)) +
      geom_point(size = 0.01) +
      
      geom_text(
        aes(Inf, Inf, label = n),
        check_overlap = TRUE,
        color         = "black",
        hjust         = 1.1,
        vjust         = 1.5,
        size          = txt_pt1 * 0.9 / .pt
      ) +
      
      scale_color_gradientn(colors = c(fade_0, .x)) +
      guides(color = guide_colorbar(barwidth = unit(0.1, "cm"))) +
      facet_wrap(~ rep, nrow = 1) +
      ggtitle(.y) +
      umap_theme +
      theme(
        plot.title      = element_text(face = "plain", size = 14),
        legend.position = "right",
        legend.title    = element_blank(),
        legend.text     = element_text(size = txt_pt1 * 0.9),
        panel.border    = element_rect(fill = NA, color = "grey85")
      )
  }) %>%
  plot_grid(
    ncol     = 1,
    plotlist = .,
    align    = "v",
    axis     = "rl"
  )

```

<br>
